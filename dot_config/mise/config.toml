# mise configuration file
# Managed by mise - https://mise.jdx.dev
# Repository: https://github.com/msavdert/dotfiles
#
# This file defines all global tools managed by mise
# Install all tools: mise install
# Update all tools: mise upgrade

[tools]
# Dotfiles management
chezmoi = "latest"

# Secret management
fnox = "latest"
age = "latest"

# Shell enhancements
starship = "latest"
zellij = "latest"

# Cloud CLIs (OCI, AWS, Azure)
# Uncomment when needed:
# oci = "latest"
# awscli = "latest"
# "azure-cli" = "latest"
# "gcloud" = "latest"
github-cli = "latest"

# Container tools
kubectl = "latest"
# kubens = "latest"
k9s = "latest"
helm = "latest"
flux2 = "latest"
kustomize = "latest"
cilium-hubble = "latest"
cilium-cli = "latest"
sops = "latest"

# Infrastructure as Code (uncomment as needed)
terraform = "latest"
# terragrunt = "latest"
# ansible = "latest"

# Development tools
jq = "latest"
yq = "latest"
cloudflared = "latest"
neovim = "latest"
usage = "latest"
velero = "latest"
uv = "latest"
node = "latest"

# Useful CLI tools (uncomment as needed)
ripgrep = "latest"
# fd = "latest"
# bat = "latest"
# eza = "latest"
# fzf = "latest"
# delta = "latest"

[settings]
# Automatically install tools when entering a directory
auto_install = true

# Use verbose output for debugging
verbose = false

# Support for legacy version files (.nvmrc, .ruby-version, etc.)
legacy_version_file = true

# Plugin aliases (short names)
[tool_alias]
aws = "awscli"
az = "azure-cli"
gh = "github-cli"
k = "kubectl"
tf = "terraform"
tg = "terragrunt"

# Environment variables
[env]
# Default kubeconfig location
#KUBECONFIG = "$HOME/.kube/config"

# Editor preferences
EDITOR = "nvim"
VISUAL = "nvim"

# Mise configuration paths
_.file = ".env"

[tasks.ghl-gen]
description = "Authenticate GitHub CLI using fnox"
run = "fnox exec -- bash -c 'echo $GITHUB_TOKEN_GENERAL | gh auth login --with-token && gh auth setup-git'"

[tasks.doctor]
description = "Check dotfiles health"
run = """
echo "=== chezmoi ===" && chezmoi doctor 2>&1 | grep -c "^ok" | xargs -I{} echo "  {} checks passed"
echo "=== mise ===" && mise list 2>/dev/null | wc -l | xargs -I{} echo "  {} tools installed"
echo "=== fnox ===" && fnox list 2>/dev/null | wc -l | xargs -I{} echo "  {} secrets available"
echo "=== git ===" && echo "  user: $(git config user.name) <$(git config user.email)>"
"""

[tasks.ssh-restore]
description = "Restore SSH keys from fnox secrets"
run = """
fnox exec -- bash -c '
  mkdir -p ~/.ssh && chmod 700 ~/.ssh
  if [ -n "$SSHKEY_K3S" ]; then
    echo "$SSHKEY_K3S" > ~/.ssh/k3s_key && chmod 600 ~/.ssh/k3s_key
    echo "✓ k3s SSH key restored"
  else
    echo "✗ SSHKEY_K3S not found in fnox"
  fi
'
"""

[tasks.k3s-connect]
description = "Connect to k3s cluster using fnox kubeconfig"
run = """
fnox exec -- bash -c '
  echo "$KUBECONFIG_K3S" > /tmp/k3s.conf
  export KUBECONFIG=/tmp/k3s.conf
  kubectl get nodes && echo "" && echo "✓ Connected! Run: export KUBECONFIG=/tmp/k3s.conf"
'
"""
